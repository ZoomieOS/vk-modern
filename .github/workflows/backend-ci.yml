name: Backend CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true

      - name: ğŸ“¦ Download dependencies
        working-directory: apps/backend
        run: go mod download

      - name: ğŸ¨ Check formatting
        working-directory: apps/backend
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "âŒ ĞĞ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ Ğ½ĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼:"
            gofmt -s -l .
            exit 1
          fi
          echo "âœ… Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ"

      - name: ğŸ” Run linter
        uses: golangci/golangci-lint-action@v4
        with:
          working-directory: apps/backend
          version: latest

      - name: ğŸ§ª Run tests
        working-directory: apps/backend
        run: go test ./... -v -race -coverprofile=coverage.out

      - name: ğŸ“Š Show test coverage
        working-directory: apps/backend
        run: go tool cover -func=coverage.out